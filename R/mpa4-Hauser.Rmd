---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(dplyr)
library(ggplot2)
library(tidyheatmaps)
library(reshape2)
library(RColorBrewer)
library(vegan)
library(FactoMineR)
library(pheatmap)
library(viridis)
library(tidyheatmaps)
library(ggridges)
library(stringr)
```


```{r}
file_path <- "/projects/b1042/HartmannLab/Hauser-mice/output/mpa4"
metadata_path <- "/projects/b1042/HartmannLab/Hauser-mice/input"

gtdb_table <- read_tsv(
  file.path(file_path, "merged_metaphlan_table.txt"),
  comment = "#",
  col_names = TRUE
) %>%
  rename(clade_name = 1) %>%      # rename column 1 to "clade_name"
  select(-profiled_PBS_S33)
colnames(gtdb_table) <- gsub("profiled_", "", colnames(gtdb_table))

metadata <- read_csv(file.path(metadata_path, "sample_metadata_final.csv"))

gtdb_table
metadata
```

```{r}

load_mpa <- function(gtdb_table, level) {
 
  # Filter and clean depending on level
  if (level == "phylum") {
    gtdb_table <- gtdb_table %>%
      filter(str_detect(clade_name, "p__")) %>%
      mutate(clade_name = sub(".*p__", "", clade_name))
  
  } 
  else if (level == "family") {
    gtdb_table <- gtdb_table %>%
      filter(str_detect(clade_name, "f__") & !str_detect(clade_name, "g__")) %>%
      mutate(clade_name = sub(".*f__", "", clade_name))
  } 
  else if (level == "genera") {
    gtdb_table <- gtdb_table %>%
      filter(str_detect(clade_name, "g__") & !str_detect(clade_name, "s__")) %>%
      mutate(clade_name = sub(".*g__", "", clade_name))
    
  } 
  else if (level == "species") {
    gtdb_table <- gtdb_table %>%
      filter(str_detect(clade_name, "s__")) %>%
      mutate(clade_name = sub(".*s__", "", clade_name))
  } 
  else {
    stop("Level must be one of: phylum, family, genera, species")
  }
  
  
  return(gtdb_table)
}

```



```{r}

tidy_joined <- function(df, metadata,
                         id_col = "clade_name",
                         sample_col = "SampleID",
                         value_col = "relative_abundance") {

  
  # Remove "gtdb_" prefix from sample column names
  colnames(df) <- gsub("^gtdb_", "", colnames(df))
  
  long_df <- df %>%
    pivot_longer(
      cols = -all_of(id_col),
      names_to  = sample_col,
      values_to = value_col
    )
  
  # Validate metadata has the sample column
  if (!(sample_col %in% names(metadata))) {
    stop("metadata must contain a '", sample_col, "' column.")
  }
  
  # Ensure matching data types before join
  long_df[[sample_col]] <- as.character(long_df[[sample_col]])
  metadata[[sample_col]] <- as.character(metadata[[sample_col]])
  
  out <- long_df %>% left_join(metadata, by = sample_col)
  return(out)
}

```


```{r}
# Calculate total and relative abundance for each SampleID
calc_relative_abundance <- function(df,
                                    sample_col = "SampleID",
                                    abundance_col = "relative_abundance") {
  df %>%
    group_by(.data[[sample_col]]) %>%
    mutate(
      Total_Abundance = sum(as.numeric(.data[[abundance_col]]), na.rm = TRUE),
      Relative_Abundance = as.numeric(.data[[abundance_col]]) / Total_Abundance
    ) %>%
    ungroup()
}
```

```{r}
# FAMILY LEVEL
family_data <- gtdb_table %>%
  load_mpa("family") %>%
  tidy_joined(metadata) %>%
  calc_relative_abundance()

# GENUS LEVEL
genus_data <- gtdb_table %>%
  load_mpa("genera") %>%
  tidy_joined(metadata) %>%
  calc_relative_abundance()

# SPECIES LEVEL
species_data <- gtdb_table %>%
  load_mpa("species") %>%
  tidy_joined(metadata) %>%
  calc_relative_abundance()
```


```{r}
# First transform the data to wide format properly
wide_data <- genus_data %>%
  select(SampleID, clade_name, Relative_Abundance) %>%
  pivot_wider(names_from = clade_name, values_from = Relative_Abundance, values_fill = 0) %>%
  column_to_rownames("SampleID")

# Calculate Bray-Curtis dissimilarity matrix
bray_curtis_matrix <- vegdist(wide_data, method = "bray")

# Make sure metadata matches the sample order
metadata_ordered <- metadata[match(rownames(wide_data), metadata$SampleID),]

# Run PERMANOVA tests
permanova_treatment <- adonis2(bray_curtis_matrix ~ Treatment, data = metadata_ordered, strata = metadata_ordered$Day, permutations = 999)
permanova_day <- adonis2(bray_curtis_matrix ~ Day, data = metadata_ordered, strata = metadata_ordered$Treatment, permutations = 999)

# Print results
print("PERMANOVA results for Treatment:")
print(permanova_treatment)
print("PERMANOVA results for Day:")
print(permanova_day)

# Extract R-squared values and p-values
r2_values <- c(permanova_treatment$R2[1], permanova_day$R2[1])
p_values <- c(permanova_treatment$`Pr(>F)`[1], permanova_day$`Pr(>F)`[1])

# Create a data frame with the results
permanova_results <- data.frame(
  Factor = c("Treatment", "Day"),
  R2 = r2_values,
  P = p_values
)

# Create the plot
p1 <- ggplot(permanova_results, aes(x = reorder(Factor, R2), y = R2)) +
    geom_bar(stat = "identity", fill = ifelse(permanova_results$P < 0.05, "steelblue", "gray")) +
    geom_text(aes(label = sprintf("R² = %.3f\np = %.3f", R2, P)), 
              vjust = -0.5, size = 4) +
    theme_minimal() +
    labs(title = "PERMANOVA Results: Variance Explained by Treatment and Day",
         x = "Factor",
         y = "R² (Variance Explained)") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          plot.title = element_text(hjust = 0.5)) +
    ylim(0, max(permanova_results$R2) * 1.2)

# Display the plot
print(p1)

# Save the plot
plots_path <- "/gpfs/projects/b1042/HartmannLab/Hauser-mice/R/Ploths"
# ggsave(
#   filename = "permanova_results_mpa_Genera.png",
#   plot = p1,
#   path = plots_path,
#   width = 10,
#   height = 6,
#   dpi = 300
# )

```

```{r}
# Perform PCoA analysis
pcoa <- cmdscale(bray_curtis_matrix, eig = TRUE, k = 2)

# Extract coordinates
pcoa_coords <- as.data.frame(pcoa$points)
colnames(pcoa_coords) <- c("PC1", "PC2")

# Calculate variance explained (as percentage)
eigenvalues <- pcoa$eig
var_explained <- eigenvalues / sum(eigenvalues) * 100

# Add metadata
pcoa_coords$SampleID <- rownames(pcoa_coords)
pcoa_data <- pcoa_coords %>%
  left_join(metadata, by = "SampleID")

# Create the plot
p2 <- ggplot(pcoa_data, aes(x = PC1, y = PC2, color = Day, shape = Treatment)) +
  geom_point(size = 4, alpha = 0.7) +
  scale_shape_manual(values = c(16, 17, 18, 15)) +
  scale_color_viridis_d(option = "turbo") +
  labs(
    title = "PCoA of Genus-level Bacterial Communities",
    x = paste0("PC1 (", round(var_explained[1], 2), "%)"),
    y = paste0("PC2 (", round(var_explained[2], 2), "%)")
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.title = element_text(size = 12),
    legend.position = "right",
    panel.grid.major = element_line(color = "lightgray", linewidth = 0.3)
  )

print(p2)

# ggsave(
#   filename = "PCoA_Genera_Hauser.png",
#   plot = p2,
#   path = plots_path,
#   width = 10,
#   height = 6,
#   dpi = 300
# )
```
```{r}
# Filter out Day -5
genus_data_filtered <- genus_data %>%
  filter(Day != "0")

# Transform to wide format
wide_data_filtered <- genus_data_filtered %>%
  filter(clade_name != "") %>%
  select(SampleID, clade_name, Relative_Abundance) %>%
  pivot_wider(names_from = clade_name, values_from = Relative_Abundance, values_fill = 0) %>%
  column_to_rownames("SampleID")

# Calculate Bray-Curtis dissimilarity matrix
bray_curtis_matrix_filtered <- vegdist(wide_data_filtered, method = "bray")

# Match metadata
metadata_ordered_filtered <- metadata[match(rownames(wide_data_filtered), metadata$SampleID),]

# Run PERMANOVA tests
permanova_treatment_filtered <- adonis2(bray_curtis_matrix_filtered ~ Treatment, data = metadata_ordered_filtered, strata = metadata_ordered_filtered$Day, permutations = 999)
permanova_day_filtered <- adonis2(bray_curtis_matrix_filtered ~ Day, data = metadata_ordered_filtered, strata = metadata_ordered_filtered$Treatment, permutations = 999)

print("PERMANOVA results for Treatment (Day -5 removed):")
print(permanova_treatment_filtered)
print("PERMANOVA results for Day (Day -5 removed):")
print(permanova_day_filtered)

# PCoA plot
pcoa_filtered <- cmdscale(bray_curtis_matrix_filtered, eig = TRUE, k = 2)
pcoa_coords_filtered <- as.data.frame(pcoa_filtered$points)
colnames(pcoa_coords_filtered) <- c("PC1", "PC2")
eigenvalues_filtered <- pcoa_filtered$eig
var_explained_filtered <- eigenvalues_filtered / sum(eigenvalues_filtered) * 100

pcoa_coords_filtered$SampleID <- rownames(pcoa_coords_filtered)
pcoa_data_filtered <- pcoa_coords_filtered %>%
  left_join(metadata, by = "SampleID")

p_filtered <- ggplot(pcoa_data_filtered, aes(x = PC1, y = PC2, color = Day, shape = Treatment)) +
  geom_point(size = 4, alpha = 0.7) +
  scale_shape_manual(values = c(16, 17, 18, 15)) +
  scale_color_viridis_d(option = "turbo") +
  labs(
    title = "PCoA of Genus-level (Day 0 Removed)",
    x = paste0("PC1 (", round(var_explained_filtered[1], 2), "%)"),
    y = paste0("PC2 (", round(var_explained_filtered[2], 2), "%)")
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.title = element_text(size = 12),
    legend.position = "right",
    panel.grid.major = element_line(color = "lightgray", linewidth = 0.3)
  )

print(p_filtered)

ggsave(
  filename = "PCoA_Genera_Hauser_day0_removed.png",
  plot = p_filtered,
  path = plots_path,
  width = 10,
  height = 6,
  dpi = 300
)
```


```{r}

#### Overall abundance patterns
# Calculate mean abundance per taxa across all samples
mean_abundance <- genus_data %>%
  group_by(clade_name) %>%
  summarize(mean_abundance = mean(Relative_Abundance)) %>%
  arrange(desc(mean_abundance)) %>%
  head(10)  # Top 10 most abundant genera

top10_genera <- mean_abundance$clade_name[1:10]

# Calculate abundance patterns across treatment and days for top 5 genera
top5_genera <- mean_abundance$clade_name[1:5]

treatment_day_patterns <- genus_data %>%
  filter(clade_name %in% top10_genera) %>%
  group_by(Day, Treatment, clade_name) %>%
  summarize(mean_abundance = mean(Relative_Abundance),
            se = sd(Relative_Abundance)/sqrt(n())) %>%
  ungroup()


p3 <- ggplot(mean_abundance,
             aes(x = reorder(clade_name, -mean_abundance),
                 y = mean_abundance * 100)) +
  geom_bar(stat = "identity", fill = "#2C5985", width = 0.7) +
  labs(
    title = "Top 10 Most Abundant Genera",
    x = "Genus",
    y = "Mean Relative Abundance (%)"
  ) +
  theme_classic(base_size = 14, base_family = "sans") +
  theme(
    plot.title = element_text(
      hjust = 0.5, size = 20, face = "bold", margin = margin(b = 15)
    ),
    axis.title.x = element_text(size = 16, face = "bold", margin = margin(t = 10)),
    axis.title.y = element_text(size = 16, face = "bold", margin = margin(r = 10)),
    axis.text.x = element_text(size = 12, angle = 45, hjust = 1, vjust = 1, color = "black"),
    axis.text.y = element_text(size = 12, color = "black", face = "bold"),
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black", linewidth = 0.8),
    plot.margin = margin(10, 15, 10, 10)
  )


p4 <- ggplot(genus_data %>% filter(clade_name %in% top10_genera), 
             aes(x = Day, y = Relative_Abundance * 100, fill = Treatment)) +
  geom_boxplot() +
  facet_wrap(~clade_name, scales = "free_y") +
  scale_fill_brewer(palette = "Set2") +
  labs(
    title = "Distribution of Top 10 Most Abundant Genera by Day and Treatment",
    y = "Relative Abundance (%)"
  ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 14, face = "bold"),
    axis.text.y = element_text(size = 10, face = "bold"),
    plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
    axis.title.x = element_text(size = 18, face = "bold"),
    axis.title.y = element_text(size = 18, face = "bold"),
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 12, face = "bold"),
    legend.position = "right",
    legend.key.size = unit(1, 'cm'),
    axis.line.x = element_line(color = "#142D4A", linewidth = 0.8),
    axis.line.y = element_line(color = "#142D4A", linewidth = 0.8),
    strip.text = element_text(size = 12, face = "bold")
  )

# Print summary statistics
print("Summary of top 10 Genera abundance by Day and Treatment:")
treatment_day_summary <- genus_data %>%
  filter(clade_name %in% top10_genera) %>%
  group_by(Day, Treatment, clade_name) %>%
  summarize(
    mean_abundance = mean(Relative_Abundance),
    sd_abundance = sd(Relative_Abundance),
    median_abundance = median(Relative_Abundance)
  )
print(treatment_day_summary)

p3
p4

ggsave(
  filename = "top_10_most_abundant_genera_hauser.png",
  plot = p3,
  path = plots_path,
  width = 10,
  height = 6,
  dpi = 300
)


# ggsave(
#   filename = "Top 10 Most Abundant Genera by Day and Treatment.png",
#   plot = p4,
#   path = plots_path,
#   width = 18,
#   height = 12,
#   dpi = 300
# )

```

```{r}
##### Core genera calculation
# Calculate presence/absence for each genus per treatment
core_genera <- genus_data %>%
  group_by(Day, clade_name) %>%
  summarize(
    Prevalence = n_distinct(SampleID[Relative_Abundance > 0.005]) / n_distinct(SampleID) * 100,
    Mean_Abundance = mean(Relative_Abundance, na.rm = TRUE),
    SD_Abundance = sd(Relative_Abundance, na.rm = TRUE)
  ) %>%
  ungroup()

# Filter for core genera (present in >80% of samples)
core_genera_filtered <- core_genera %>%
  filter(Prevalence >= 70) %>%
  arrange(Day, desc(Mean_Abundance))

##### Core species calculation
core_species <- species_data %>%
  group_by(Day, clade_name) %>%
  summarize(
    Prevalence = n_distinct(SampleID[Relative_Abundance > 0.005]) / n_distinct(SampleID) * 100,
    Mean_Abundance = mean(Relative_Abundance, na.rm = TRUE),
    SD_Abundance = sd(Relative_Abundance, na.rm = TRUE)
  ) %>%
  ungroup()

# Filter for core species (present in >80% of samples)
core_species_filtered <- core_species %>%
  filter(Prevalence >= 70) %>%
  arrange(Day, desc(Mean_Abundance))

core_genera_list <- unique(core_genera_filtered$clade_name)
core_species_list <- unique(core_species_filtered$clade_name)

```

```{r}
custom_colors <- c("#26456E", "#1c54a8", "#FFE04F", "#ffbb78","#EC6E1C", "#9F3632")

# 2. Heatmap of prevalence
p_core_g <- ggplot(core_genera_filtered, 
             aes(x = reorder(clade_name, -Prevalence), 
                 y = Day, 
                 fill = Prevalence)) +
  geom_tile() +
  scale_fill_gradientn(colors = custom_colors) +
  coord_fixed() +
  labs(
    title = " >70% Prevelant Genera",
    x = "Genus",
    y = "Day",
    fill = "Prevalence (%)"
  ) + theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
  ) + theme(
    legend.position = "bottom",
    strip.text = element_text(size = 18, face = "bold", color = "black"),
    strip.background = element_rect(fill = "gray90", color = "gray20"),
    axis.text.x = element_text(size = 16,angle = 45, hjust = 1),
    axis.text.y = element_text(size = 16, face = "bold"),
    axis.title = element_text(size = 16, face = "bold"),
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5),
    legend.title = element_text(size = 20, face = "bold"),
    legend.text = element_text(size = 18)
  )


p_core_s <- ggplot(core_species_filtered, 
             aes(x = reorder(clade_name, -Prevalence), 
                 y = Day, 
                 fill = Prevalence)) +
  geom_tile() +
  scale_fill_gradientn(colors = custom_colors) +
  coord_fixed() +
  labs(
    title = " >70% Prevelant Spicies",
    x = "Species",
    y = "Day",
    fill = "Prevalence (%)"
  ) +
  theme(legend.position = "bottom") +   # put legend below plot
  guides(
    fill = guide_colourbar(
      title.position = "top",
      title.hjust    = 0.5,
      barwidth       = unit(8, "cm"),   # make the bar long
      barheight      = unit(0.5, "cm"), # and comfortably thick
      label.theme    = element_text(size = 12, face = "bold")
    )
  ) + theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
  ) + theme(
    legend.position = "bottom",
    strip.text = element_text(size = 18, face = "bold", color = "black"),
    strip.background = element_rect(fill = "gray90", color = "gray20"),
    axis.text.x = element_text(size = 16,angle = 45, hjust = 1),
    axis.text.y = element_text(size = 16, face = "bold"),
    axis.title = element_text(size = 16, face = "bold"),
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5),
    legend.title = element_text(size = 20, face = "bold"),
    legend.text = element_text(size = 18)
  )

print(p_core_g)
print(p_core_s)

# ggsave(
#   filename = "70 prevalent Genera by Day .png",
#   plot = p_core_g,
#   path = plots_path,
#   width = 18,
#   height = 12,
#   dpi = 300
# )
# 
# 
# ggsave(
#   filename = "70 prevalent Species by Day .png",
#   plot = p_core_s,
#   path = plots_path,
#   width = 18,
#   height = 12,
#   dpi = 300
# )

```


```{r}
# Filter for Day -5 baseline samples only
baseline_data <- genus_data %>%
  filter(Day == -5)

# Create wide matrix for heatmap (genera as rows, samples as columns)
baseline_wide <- baseline_data %>%
  select(SampleID, clade_name, Relative_Abundance) %>%
  pivot_wider(names_from = SampleID, values_from = Relative_Abundance, values_fill = 0) %>%
  column_to_rownames("clade_name")

# Remove genera with zero abundance across all samples
baseline_wide <- baseline_wide[rowSums(baseline_wide) > 0, ]

# Optional: Filter to genera with mean abundance > threshold for cleaner visualization
# Adjust threshold as needed (e.g., 0.001 = 0.1%)
abundance_threshold <- 0.001
baseline_wide_filtered <- baseline_wide[rowMeans(baseline_wide) > abundance_threshold, ]

# Get sample metadata for annotation
sample_annotation <- baseline_data %>%
  select(SampleID, Treatment) %>%
  distinct() %>%
  column_to_rownames("SampleID")

# Create heatmap with pheatmap
p_baseline <- pheatmap(
  as.matrix(baseline_wide_filtered),
  scale = "row",  # Scale by row to highlight variation across samples
  clustering_distance_rows = "euclidean",
  clustering_distance_cols = "euclidean",
  clustering_method = "complete",
  annotation_col = sample_annotation,
  color = colorRampPalette(c("#26456E", "#1c54a8", "white", "#FFE04F", "#EC6E1C"))(100),
  fontsize_row = 8,
  fontsize_col = 10,
  main = "Baseline (Day -5) Genus Relative Abundance Across Samples",
  show_rownames = TRUE,
  show_colnames = TRUE,
  border_color = NA
)

# Alternative: Log-transformed version for better visualization of low-abundance taxa
baseline_wide_log <- log10(baseline_wide_filtered + 1e-6)  # Add pseudocount

p_baseline_log <- pheatmap(
  as.matrix(baseline_wide_log),
  clustering_distance_rows = "euclidean",
  clustering_distance_cols = "euclidean",
  clustering_method = "complete",
  annotation_col = sample_annotation,
  color = viridis(100),
  fontsize_row = 8,
  fontsize_col = 10,
  main = "Baseline (Day -5) Log10 Genus Abundance",
  show_rownames = TRUE,
  show_colnames = TRUE,
  border_color = NA
)

# Save the plots
# ggsave not directly compatible with pheatmap, use png() instead:
png(file.path(plots_path, "baseline_day-5_genus_heatmap.png"),
    width = 18, height = 14, units = "in", res = 300)
print(p_baseline)
dev.off()
```

