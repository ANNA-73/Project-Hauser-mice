---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(dplyr)
library(ggplot2)
library(tidyheatmaps)
library(reshape2)
library(RColorBrewer)
library(vegan)
library(FactoMineR)
library(pheatmap)
library(viridis)
library(tidyheatmaps)
library(ggridges)
library(stringr)
```


```{r}
file_path <- "/projects/b1042/HartmannLab/Hauser-mice/output/mpa4"
metadata_path <- "/projects/b1042/HartmannLab/Hauser-mice/input"

gtdb_table <- read_tsv(
  file.path(file_path, "merged_metaphlan_table.txt"),
  comment = "#",
  col_names = TRUE
) %>%
  
  rename(clade_name = 1) %>%      # rename column 1 to "clade_name"
  select(-profiled_PBS_S33)
colnames(gtdb_table) <- gsub("profiled_", "", colnames(gtdb_table))

metadata <- read_csv(file.path(metadata_path, "sample_metadata_final.csv"))

gtdb_table
metadata
```

```{r}

load_mpa <- function(gtdb_table, level) {
 
  # Filter and clean depending on level
  if (level == "phylum") {
    gtdb_table <- gtdb_table %>%
      filter(str_detect(clade_name, "p__")) %>%
      mutate(clade_name = sub(".*p__", "", clade_name))
  
  } 
  else if (level == "family") {
    gtdb_table <- gtdb_table %>%
      filter(str_detect(clade_name, "f__") & !str_detect(clade_name, "g__")) %>%
      mutate(clade_name = sub(".*f__", "", clade_name))
  } 
  else if (level == "genera") {
    gtdb_table <- gtdb_table %>%
      filter(str_detect(clade_name, "g__") & !str_detect(clade_name, "s__")) %>%
      mutate(clade_name = sub(".*g__", "", clade_name))
    
  } 
  else if (level == "species") {
    gtdb_table <- gtdb_table %>%
      filter(str_detect(clade_name, "s__")) %>%
      mutate(clade_name = sub(".*s__", "", clade_name))
  } 
  else {
    stop("Level must be one of: phylum, family, genera, species")
  }
  
  
  return(gtdb_table)
}

```



```{r}

tidy_joined <- function(df, metadata,
                         id_col = "clade_name",
                         sample_col = "SampleID",
                         value_col = "relative_abundance") {

  
  # Remove "gtdb_" prefix from sample column names
  colnames(df) <- gsub("^gtdb_", "", colnames(df))
  
  long_df <- df %>%
    pivot_longer(
      cols = -all_of(id_col),
      names_to  = sample_col,
      values_to = value_col
    )
  
  # Validate metadata has the sample column
  if (!(sample_col %in% names(metadata))) {
    stop("metadata must contain a '", sample_col, "' column.")
  }
  
  # Ensure matching data types before join
  long_df[[sample_col]] <- as.character(long_df[[sample_col]])
  metadata[[sample_col]] <- as.character(metadata[[sample_col]])
  
  out <- long_df %>% left_join(metadata, by = sample_col)
  return(out)
}

```


```{r}
# Calculate total and relative abundance for each SampleID
calc_relative_abundance <- function(df,
                                    sample_col = "SampleID",
                                    abundance_col = "relative_abundance") {
  df %>%
    group_by(.data[[sample_col]]) %>%
    mutate(
      Total_Abundance = sum(as.numeric(.data[[abundance_col]]), na.rm = TRUE),
      Relative_Abundance = as.numeric(.data[[abundance_col]]) / Total_Abundance
    ) %>%
    ungroup()
}
```

```{r}
# FAMILY LEVEL
family_data <- gtdb_table %>%
  load_mpa("family") %>%
  tidy_joined(metadata) %>%
  calc_relative_abundance()

# GENUS LEVEL
genus_data <- gtdb_table %>%
  load_mpa("genera") %>%
  tidy_joined(metadata) %>%
  calc_relative_abundance()

# SPECIES LEVEL
species_data <- gtdb_table %>%
  load_mpa("species") %>%
  tidy_joined(metadata) %>%
  calc_relative_abundance()
```



```{r}
## separating baseline from others

full_genus_data <- genus_data %>%
  mutate(Mouse = as.factor(Mouse)) 

# 2. Baseline only (Day -5)
baseline_data <- genus_data %>%
  filter(Day == -5)%>%
  mutate(Mouse = as.factor(Mouse)) 

# 3. Post-treatment only (Days 0, 3, 10, 14)
post_treatment_data <- genus_data %>%
  filter(Day %in% c(0, 3, 10, 14)) %>%
  mutate(Mouse = as.factor(Mouse)) 
```



#all samples
```{r}
## separating baseline from others
full_genus_data <- genus_data %>%
  mutate(Mouse = as.factor(Mouse)) 

# 2. Baseline only (Day -5)
baseline_data <- genus_data %>%
  filter(Day == -5) %>%
  mutate(Mouse = as.factor(Mouse)) 

# 3. Post-treatment only (Days 0, 3, 10, 14)
post_treatment_data <- genus_data %>%
  filter(Day %in% c(0, 3, 10, 14)) %>%
  mutate(Mouse = as.factor(Mouse)) 

# First transform the data to wide format properly
wide_data <- full_genus_data %>%
  select(SampleID, clade_name, Relative_Abundance) %>%
  pivot_wider(names_from = clade_name, values_from = Relative_Abundance, values_fill = 0) %>%
  column_to_rownames("SampleID")

# Calculate Bray-Curtis dissimilarity matrix
bray_curtis_matrix <- vegdist(wide_data, method = "bray")

# Match metadata to sample order
metadata_all <- metadata %>%
  filter(SampleID %in% rownames(wide_data)) %>%
  mutate(Mouse = as.factor(Mouse)) %>%
  arrange(match(SampleID, rownames(wide_data)))

# PERMANOVA tests
# Treatment: between-mouse factor, no strata needed
permanova_treatment_all <- adonis2(bray_curtis_matrix ~ Treatment,
                                    data = metadata_all, 
                                    permutations = 999)

# Day: within-mouse factor, block by Mouse
permanova_day_all <- adonis2(bray_curtis_matrix ~ Day,
                              data = metadata_all, 
                              strata = metadata_all$Mouse,
                              permutations = 999)

# Mouse: individual variation
permanova_mouse_all <- adonis2(bray_curtis_matrix ~ Mouse,
                                data = metadata_all,
                                permutations = 999)

print("=== FULL DATASET PERMANOVA (Days: -5, 0, 3, 10, 14) ===")
print("Treatment effect:")
print(permanova_treatment_all)
print("\nDay effect (blocking by Mouse):")
print(permanova_day_all)
print("\nMouse effect (individual variation):")
print(permanova_mouse_all)

# Create summary plot - FIXED syntax
permanova_results <- data.frame(
  Factor = c("Treatment", "Day", "Mouse"),
  R2 = c(permanova_treatment_all$R2[1], 
         permanova_day_all$R2[1],
         permanova_mouse_all$R2[1]),
  P_value = c(permanova_treatment_all$`Pr(>F)`[1], 
              permanova_day_all$`Pr(>F)`[1],
              permanova_mouse_all$`Pr(>F)`[1])
)

p_permanova <- ggplot(permanova_results, aes(x = Factor, y = R2, fill = P_value < 0.05)) +
  geom_bar(stat = "identity", width = 0.5) +
  geom_text(aes(label = sprintf("R² = %.3f\np = %.3f", R2, P_value)), 
            vjust = -0.5, size = 4, fontface = "bold") +
  scale_fill_manual(values = c("TRUE" = "lightblue", "FALSE" = "gray70"),
                    labels = c("TRUE" = "p < 0.05", "FALSE" = "p ≥ 0.05")) +
  labs(
    title = "PERMANOVA Results: All Samples Microbiome",
    x = "",
    y = "R² (Variance Explained)",
    fill = "Significance"
  ) +
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.text.x = element_text(size = 14, face = "bold"),
    axis.title = element_text(size = 14, face = "bold"),
    legend.position = "bottom",
    legend.title = element_text(size = 12, face = "bold")
  ) +
  ylim(0, max(permanova_results$R2) * 1.25)

print(p_permanova)
# Save the plot
plots_path <- "/gpfs/projects/b1042/HartmannLab/Hauser-mice/R/Plots"

ggsave(
  filename = "permanova_results_all.png",
  plot = p_permanova,
  path = plots_path,
  width = 10,
  height = 6,
  dpi = 300
)

```
#Baseline only
```{r}
## BASELINE only ( Day -5)
## for this I 'll group by Mouse first then by clade to have 1 sample represent each mouse - mean of all samples for that mouse

baseline_mouse_level <- baseline_data %>%
  group_by(Mouse, clade_name) %>%
  summarize(mean_abundance = mean(Relative_Abundance), .groups = "drop")

print("Baseline data aggregated to mouse level:")
print(head(baseline_mouse_level))

#====================================================================================
#======================================================================================

top10_baseline <- baseline_mouse_level %>%
  group_by(clade_name) %>%
  summarize(mean_abundance = mean(mean_abundance)) %>%
  arrange(desc(mean_abundance)) %>%
  head(10)

p_top10_baseline <- ggplot(top10_baseline,
             aes(x = reorder(clade_name, -mean_abundance),
                 y = mean_abundance * 100)) +
  geom_bar(stat = "identity", fill = "#8B4513", width = 0.7) +
  labs(
    title = "Top 10 Most Abundant Genera - Baseline (Day -5)",
    x = "Genus",
    y = "Mean Relative Abundance (%)"
  ) +
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 10, face = "italic"),
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
  )

print(p_top10_baseline)

#====================================================================================
#======================================================================================

baseline_variation <- baseline_mouse_level %>%
  group_by(clade_name) %>%
  summarize(
    mean_abundance = mean(mean_abundance),
    sd_abundance = sd(mean_abundance),
    cv = (sd_abundance / mean_abundance) * 100,
    n_mice = n()
  ) %>%
  filter(mean_abundance > 0.001) %>%  # Filter out very low abundance
  arrange(desc(mean_abundance))

print("Coefficient of Variation for top genera at baseline:")
print(head(baseline_variation, 20))

#====================================================================================
#======================================================================================


baseline_top_genera <- baseline_mouse_level %>%
  filter(clade_name %in% top10_baseline$clade_name)

p_baseline_heatmap <- ggplot(baseline_top_genera, 
                             aes(x = as.factor(Mouse), y = clade_name, fill = mean_abundance * 100)) +
  geom_tile(color = "white") +
  scale_fill_viridis_c(option = "plasma") +
  labs(
    title = "Baseline Microbiome Composition by Mouse (Day -5)",
    subtitle = "Top 10 most abundant genera",
    x = "Mouse ID",
    y = "Genus",
    fill = "Mean Relative\nAbundance (%)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 10, face = "italic"),
    axis.text.x = element_text(angle = 90, hjust = 0.5, size = 10),
    axis.text.y = element_text(size = 10)
  )

print(p_baseline_heatmap)


#========================================================================================
#========================================================================================

wide_baseline <- baseline_mouse_level %>%
  pivot_wider(names_from = clade_name, values_from = mean_abundance, values_fill = 0) %>%
  column_to_rownames("Mouse")

# Calculate Bray-Curtis dissimilarity between mice
bray_baseline <- vegdist(wide_baseline, method = "bray")

# Summary statistics of between-mouse distances
baseline_dist_summary <- data.frame(
  min_distance = min(bray_baseline),
  mean_distance = mean(bray_baseline),
  max_distance = max(bray_baseline),
  sd_distance = sd(bray_baseline)
)

print("Baseline inter-mouse Bray-Curtis dissimilarity:")
print(baseline_dist_summary)

# Convert distance object to matrix
dist_matrix <- as.matrix(bray_baseline)

# Convert to long format for ggplot - only lower triangle
dist_long <- dist_matrix %>%
  as.data.frame() %>%
  rownames_to_column("Mouse1") %>%
  pivot_longer(-Mouse1, names_to = "Mouse2", values_to = "Distance") %>%
  filter(Mouse1 != Mouse2) %>%  # Remove diagonal
  rowwise() %>%
  mutate(
    min_mouse = min(c(Mouse1, Mouse2)),
    max_mouse = max(c(Mouse1, Mouse2))
  ) %>%
  ungroup() %>%
  distinct(min_mouse, max_mouse, .keep_all = TRUE) %>%
  select(Mouse1, Mouse2, Distance)

custom_colors <- c("#26456E", "#1c54a8", "#FFE04F")

# Calculate mean distance for subtitle
mean_dist <- round(baseline_dist_summary$mean_distance, 3)

p_distance_heatmap <- ggplot(dist_long, aes(x = Mouse2, y = Mouse1, fill = Distance)) +
  geom_tile(color = "white", linewidth = 1.5) +
  geom_text(aes(label = round(Distance, 3)), color = "black", size = 5, fontface = "bold") +
  scale_fill_gradientn(colors = custom_colors, limits = c(0, max(dist_long$Distance))) +
  labs(
    title = "Pairwise Bray-Curtis Distances Between Mice at Baseline",
    subtitle = paste0("Mean Distance = ", mean_dist),  # DYNAMIC
    x = "Mouse ID",
    y = "Mouse ID",
    fill = "Bray-Curtis\nDissimilarity"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 10, face = "italic"),
    axis.text.x = element_text(angle= 90, size = 12, face = "bold"),
    axis.text.y = element_text(angle= 0, size = 12, face = "bold"),
    axis.title = element_text(size = 12, face = "bold"),
    legend.title = element_text(size = 10, face = "bold"),
    panel.grid = element_blank()
  ) +
  coord_fixed()

print(p_distance_heatmap)


 ggsave("baseline_distance_heatmap.png", p_distance_heatmap,
        path = plots_path, width = 8, height = 7, dpi = 300)

 ggsave("p_top10_baseline.png", p_top10_baseline,
        path = plots_path, width = 8, height = 7, dpi = 300)

```
##what abt day 0?

```{r}
dayzero_data <- genus_data %>%
  filter(Day == 0)%>%
  mutate(Mouse = as.factor(Mouse)) 

baseline_mouse_level <- dayzero_data %>%
  group_by(Mouse, clade_name) %>%
  summarize(mean_abundance = mean(Relative_Abundance), .groups = "drop")

wide_baseline <- baseline_mouse_level %>%
  pivot_wider(names_from = clade_name, values_from = mean_abundance, values_fill = 0) %>%
  column_to_rownames("Mouse")

# Calculate Bray-Curtis dissimilarity between mice
bray_baseline <- vegdist(wide_baseline, method = "bray")

# Summary statistics of between-mouse distances
baseline_dist_summary <- data.frame(
  min_distance = min(bray_baseline),
  mean_distance = mean(bray_baseline),
  max_distance = max(bray_baseline),
  sd_distance = sd(bray_baseline)
)

print("Baseline inter-mouse Bray-Curtis dissimilarity:")
print(baseline_dist_summary)

# Convert distance object to matrix
dist_matrix <- as.matrix(bray_baseline)

# Convert to long format for ggplot - only lower triangle
dist_long <- dist_matrix %>%
  as.data.frame() %>%
  rownames_to_column("Mouse1") %>%
  pivot_longer(-Mouse1, names_to = "Mouse2", values_to = "Distance") %>%
  filter(Mouse1 != Mouse2) %>%  # Remove diagonal
  rowwise() %>%
  mutate(
    min_mouse = min(c(Mouse1, Mouse2)),
    max_mouse = max(c(Mouse1, Mouse2))
  ) %>%
  ungroup() %>%
  distinct(min_mouse, max_mouse, .keep_all = TRUE) %>%
  select(Mouse1, Mouse2, Distance)

custom_colors <- c("#26456E", "#1c54a8", "#FFE04F")

# Calculate mean distance for subtitle
mean_dist <- round(baseline_dist_summary$mean_distance, 3)

p_distance_heatmap <- ggplot(dist_long, aes(x = Mouse2, y = Mouse1, fill = Distance)) +
  geom_tile(color = "white", linewidth = 1.5) +
  geom_text(aes(label = round(Distance, 3)), color = "black", size = 5, fontface = "bold") +
  scale_fill_gradientn(colors = custom_colors, limits = c(0,0.5) ) +
  labs(
    title = "Pairwise Bray-Curtis Distances Between Mice at Day0",
    subtitle = paste0("Mean Distance = ", mean_dist),  # DYNAMIC
    x = "Mouse ID",
    y = "Mouse ID",
    fill = "Bray-Curtis\nDissimilarity"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 10, face = "italic"),
    axis.text.x = element_text(angle= 90, size = 12, face = "bold"),
    axis.text.y = element_text(angle= 0, size = 12, face = "bold"),
    axis.title = element_text(size = 12, face = "bold"),
    legend.title = element_text(size = 10, face = "bold"),
    panel.grid = element_blank()
  ) +
  coord_fixed()

print(p_distance_heatmap)

ggsave(
  filename = file.path(plots_path, "day0_distance_heatmap.png"),
  plot = p_distance_heatmap,
  width = 14,
  height = 12,
  dpi = 300
)

```
## ok this was interesting. Let's do comparison in BC distances  between in diffrent timepoints. Remember day -5 is the baseline, before any  vancomycin

```{r}


# BETWEEN-TREATMENT BRAY-CURTIS DISTANCES OVER TIME
# Broken down by treatment pair, referenced to Day -5


# Function to calculate between-treatment distances for a specific day
calc_between_treatment_distances <- function(genus_data, day_filter) {
  

  # Filter data for the specific day
 day_data <- genus_data %>%
    filter(Day == day_filter) %>%
    mutate(Mouse = as.factor(Mouse))
  
  # Aggregate to mouse level (mean abundance per mouse per genus)
  mouse_level <- day_data %>%
    group_by(Mouse, clade_name) %>%
    summarize(mean_abundance = mean(Relative_Abundance), .groups = "drop")
  
  # Convert to wide format
  wide_data <- mouse_level %>%
    pivot_wider(names_from = clade_name, values_from = mean_abundance, values_fill = 0) %>%
    column_to_rownames("Mouse")
  
  # Calculate Bray-Curtis distance matrix
  bray_dist <- vegdist(wide_data, method = "bray")
  dist_matrix <- as.matrix(bray_dist)
  
  # Convert to long format with mouse pair info
  dist_long <- dist_matrix %>%
    as.data.frame() %>%
    rownames_to_column("Mouse1") %>%
    pivot_longer(-Mouse1, names_to = "Mouse2", values_to = "Distance") %>%
    filter(Mouse1 < Mouse2)  # Keep only unique pairs (lower triangle)
  
  # Extract treatment from mouse names (format: "Treatment-Number")
  dist_long <- dist_long %>%
    mutate(
      Treatment1 = str_extract(Mouse1, "^[A-Z]+"),
      Treatment2 = str_extract(Mouse2, "^[A-Z]+")
    )
  
  # Create treatment pair label (alphabetically sorted for consistency)
  dist_long <- dist_long %>%
    rowwise() %>%
    mutate(
      Treatment_Pair = paste(sort(c(Treatment1, Treatment2)), collapse = " ↔ ")
    ) %>%
    ungroup()
  
  # Filter for BETWEEN-treatment pairs only (exclude within-treatment)
  between_treatment <- dist_long %>%
    filter(Treatment1 != Treatment2) %>%
    mutate(Day = day_filter)
  
  return(between_treatment)
}

# Calculate for all timepoints
timepoints <- c(-5, 0, 3, 10, 14)

all_between_distances <- map_dfr(timepoints, function(d) {
  calc_between_treatment_distances(genus_data, d)
})

# Summarize: mean and SE per treatment pair per day
between_summary <- all_between_distances %>%
  group_by(Day, Treatment_Pair) %>%
  summarize(
    mean_distance = mean(Distance),
    sd_distance = sd(Distance),
    n_pairs = n(),
    se_distance = sd_distance / sqrt(n_pairs),
    .groups = "drop"
  )

# Calculate change from baseline (Day -5)
baseline_distances <- between_summary %>%
  filter(Day == -5) %>%
  select(Treatment_Pair, baseline_distance = mean_distance)

between_summary <- between_summary %>%
  left_join(baseline_distances, by = "Treatment_Pair") %>%
  mutate(
    change_from_baseline = mean_distance - baseline_distance,
    fold_change = mean_distance / baseline_distance
  )

# Print summary table
print("=== BETWEEN-TREATMENT DISTANCES BY TIMEPOINT ===")
print(between_summary %>% 
        select(Day, Treatment_Pair, mean_distance, se_distance, change_from_baseline) %>%
        arrange(Treatment_Pair, Day))



########
#Now plotting
##########


pair_colors <- c(
 "CK ↔ CZ" = "#E41A1C",
  "CK ↔ V" = "#377EB8", 
  "CK ↔ ZK" = "#4DAF4A",
  "CZ ↔ V" = "#984EA3",
  "CZ ↔ ZK" = "#FF7F00",
  "V ↔ ZK" = "#A65628"
)

# =============================================================================
# FACETED HEATMAP: Treatment × Treatment matrix for each Day (lower triangle only)
# =============================================================================

# Reshape data to have Treatment1, Treatment2 as separate axes
heatmap_data <- between_summary %>%
  separate(Treatment_Pair, into = c("Trt1", "Trt2"), sep = " ↔ ", remove = FALSE) %>%
  select(Day, Trt1, Trt2, mean_distance)

# Create mirror image for symmetric matrix (add both directions)
heatmap_symmetric <- bind_rows(
  heatmap_data,
  heatmap_data %>% rename(Trt1 = Trt2, Trt2 = Trt1)
)

# Add diagonal (same treatment = 0 distance, or NA to leave blank)
treatments <- c("CK", "CZ", "V", "ZK")
days <- c(-5, 0, 3, 10, 14)

diagonal <- expand_grid(Day = days, Trt = treatments) %>%
  mutate(Trt1 = Trt, Trt2 = Trt, mean_distance = NA) %>%
  select(-Trt)

heatmap_full <- bind_rows(heatmap_symmetric, diagonal)

# Order treatments and days (important: do this BEFORE filtering to numeric positions)
heatmap_full <- heatmap_full %>%
  mutate(
    Trt1 = factor(Trt1, levels = c("V", "CK", "CZ", "ZK")),
    Trt2 = factor(Trt2, levels = c("V", "CK", "CZ", "ZK")),
    Day = factor(Day, levels = c(-5, 0, 3, 10, 14), labels = c("Day -5", "Day 0", "Day 3", "Day 10", "Day 14"))
  )

# Keep only the bottom triangle (including diagonal)
heatmap_lower <- heatmap_full %>%
  filter(as.numeric(Trt1) >= as.numeric(Trt2))

# Plot (use the lower-triangle data frame)
p_facet_heatmap <- ggplot(heatmap_lower, 
                          aes(x = Trt2, y = Trt1, fill = mean_distance)) +
  geom_tile(color = "white", linewidth = 1.2) +
  geom_text(aes(label = ifelse(is.na(mean_distance), "", sprintf("%.2f", mean_distance))), 
            color = "black", size = 4, fontface = "bold") +
  facet_wrap(~Day, nrow = 1) +
  scale_fill_gradientn(
    colors = c("#26456E", "#1c54a8", "#FFE04F", "#EC6E1C", "#9F3632"),
    limits = c(0, 1),
    na.value = "gray90",
    name = "Mean Bray-Curtis\nDistance"
  ) +
  labs(
    title = "Between-Treatment Microbiome Dissimilarity Across Time",
    subtitle = "Each panel shows pairwise treatment distances at that timepoint",
    x = "",
    y = ""
  ) +
  coord_fixed() +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 11, face = "italic"),
    axis.text.x = element_text(size = 11, face = "bold", angle = 0),
    axis.text.y = element_text(size = 11, face = "bold"),
    strip.text = element_text(size = 12, face = "bold"),
    strip.background = element_rect(fill = "gray95", color = NA),
    legend.position = "right",
    legend.title = element_text(size = 10, face = "bold"),
    panel.grid = element_blank()
  )

print(p_facet_heatmap)

# Save to file (adjust path/size as needed)
dir.create(plots_path, recursive = TRUE, showWarnings = FALSE)
ggsave("between_treatment_distances_faceted_lower_triangle.png", p_facet_heatmap,
       path = plots_path, width = 16, height = 5, dpi = 300)

```
###another cool analysis, each indivual mouse has it's baseline, let's follow while comaring to that

```{r}
# =============================================================================
# INDIVIDUAL MOUSE TRAJECTORIES: Distance from own baseline (Day -5)
# =============================================================================

# Function to calculate distance from baseline for each mouse
calc_distance_from_baseline <- function(genus_data) {
  
  # Get list of mice
  mice <- unique(genus_data$Mouse)
  
  results <- list()
  
  for (m in mice) {
    
    # Get all data for this mouse
    mouse_data <- genus_data %>%
      filter(Mouse == m)
    
    # Get treatment for this mouse
    mouse_treatment <- unique(mouse_data$Treatment)
    
    # Get timepoints available for this mouse
    timepoints <- unique(mouse_data$Day)
    
    # Skip if no baseline
    if (!(-5 %in% timepoints)) {
      next
    }
    
    # Aggregate to day level for this mouse (in case of replicates)
    mouse_daily <- mouse_data %>%
      group_by(Day, clade_name) %>%
      summarize(mean_abundance = mean(Relative_Abundance), .groups = "drop")
    
    # Convert to wide format
    mouse_wide <- mouse_daily %>%
      pivot_wider(names_from = clade_name, values_from = mean_abundance, values_fill = 0) %>%
      column_to_rownames("Day")
    
    # Get baseline (Day -5) as reference
    baseline_profile <- mouse_wide["-5", , drop = FALSE]
    
    # Calculate distance from baseline for each other timepoint
    for (d in timepoints) {
      if (d == -5) {
        # Distance to self is 0
        results[[length(results) + 1]] <- data.frame(
          Mouse = m,
          Treatment = mouse_treatment,
          Day = d,
          Distance_from_baseline = 0
        )
      } else {
        day_profile <- mouse_wide[as.character(d), , drop = FALSE]
        
        # Combine and calculate Bray-Curtis
        combined <- rbind(baseline_profile, day_profile)
        bc_dist <- vegdist(combined, method = "bray")
        
        results[[length(results) + 1]] <- data.frame(
          Mouse = m,
          Treatment = mouse_treatment,
          Day = d,
          Distance_from_baseline = as.numeric(bc_dist)
        )
      }
    }
  }
  
  return(bind_rows(results))
}

# Calculate distances
mouse_trajectories <- calc_distance_from_baseline(genus_data)

# Check the data
print("=== INDIVIDUAL MOUSE DISTANCES FROM BASELINE ===")
print(mouse_trajectories %>% arrange(Mouse, Day))

# =============================================================================
# PLOT 1: Individual trajectories with treatment coloring
# =============================================================================

treatment_colors <- c("CK" = "#3770AC", "CZ" = "#9E421E", "V" = "#8C8C8C", "ZK" = "#327341")

p_individual <- ggplot(mouse_trajectories, 
                       aes(x = Day, y = Distance_from_baseline, 
                           color = Treatment, group = Mouse)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50", linewidth = 0.8) +
  geom_line(linewidth = 0.8, alpha = 0.7) +
  geom_point(size = 2.5, alpha = 0.9) +
  scale_color_manual(values = treatment_colors) +
  scale_x_continuous(breaks = c(-5, 0, 3, 10, 14)) +
  scale_y_continuous(limits = c(0, 1)) +
  annotate("text", x = 0.5, y = 0.95, 
           label = "Antibiotics +\nInoculation", size = 3, hjust = 0, fontface = "italic") +
  labs(
    title = "Individual Mouse Microbiome Change from Baseline",
    subtitle = "Each line = one mouse; Distance = Bray-Curtis dissimilarity from own Day -5",
    x = "Day",
    y = "Bray-Curtis Distance from Baseline",
    color = "Treatment"
  ) +
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 10, face = "italic"),
    axis.title = element_text(size = 14, face = "bold"),
    axis.text = element_text(size = 12, face = "bold"),
    legend.position = "right",
    legend.title = element_text(size = 12, face = "bold")
  )

print(p_individual)

# =============================================================================
# PLOT 2: Summary by treatment group (mean ± SE)
# =============================================================================

trajectory_summary <- mouse_trajectories %>%
  group_by(Treatment, Day) %>%
  summarize(
    mean_distance = mean(Distance_from_baseline),
    sd_distance = sd(Distance_from_baseline),
    n = n(),
    se_distance = sd_distance / sqrt(n),
    .groups = "drop"
  )

p_summary <- ggplot(trajectory_summary, 
                    aes(x = Day, y = mean_distance, color = Treatment, group = Treatment)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50", linewidth = 0.8) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 3.5) +
  geom_errorbar(aes(ymin = mean_distance - se_distance, 
                    ymax = mean_distance + se_distance),
                width = 0.5, linewidth = 0.8) +
  scale_color_manual(values = treatment_colors) +
  scale_x_continuous(breaks = c(-5, 0, 3, 10, 14)) +
  scale_y_continuous(limits = c(0, 1)) +
  annotate("text", x = 0.5, y = 0.95, 
           label = "Antibiotics +\nInoculation", size = 3, hjust = 0, fontface = "italic") +
  labs(
    title = "Microbiome Deviation from Baseline by Treatment",
    x = "Day",
    y = "Mean Bray-Curtis Distance from Baseline",
    color = "Treatment"
  ) +
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 10, face = "italic"),
    axis.title = element_text(size = 14, face = "bold"),
    axis.text = element_text(size = 12, face = "bold"),
    legend.position = "right",
    legend.title = element_text(size = 12, face = "bold")
  )

print(p_summary)

ggsave("Ind_mice_from_baseline-SDsummary.png", p_summary,
       path = plots_path, width = 12, height = 8, dpi = 300)


# =============================================================================
# PLOT 3: Faceted by treatment to see individual variation within groups
# =============================================================================

p_faceted <- ggplot(mouse_trajectories, 
                    aes(x = Day, y = Distance_from_baseline, group = Mouse)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50", linewidth = 0.6) +
  geom_line(aes(color = Treatment), linewidth = 0.9, alpha = 0.8) +
  geom_point(aes(color = Treatment), size = 2) +
  facet_wrap(~Treatment, nrow = 1) +
  scale_color_manual(values = treatment_colors) +
  scale_x_continuous(breaks = c(-5, 0, 3, 10, 14)) +
  scale_y_continuous(limits = c(0, 1)) +
  labs(
    title = "Individual Mouse Temporal Dynamics by Treatment Group",
    subtitle = "Each line = one mouse tracking distance from its own Day -5 baseline",
    x = "Day",
    y = "Bray-Curtis Distance from Baseline"
  ) +
  theme_classic(base_size = 12) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 10, face = "italic"),
    axis.title = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(size = 10, face = "bold", angle = 45, hjust = 1),
    axis.text.y = element_text(size = 10, face = "bold"),
    strip.text = element_text(size = 14, face = "bold"),
    strip.background = element_rect(fill = "gray95"),
    legend.position = "none"
  )

print(p_faceted)

ggsave("Ind_mice_from_baseline-facet.png", p_faceted,
       path = plots_path, width = 16, height = 5, dpi = 300)

# =============================================================================
# Print summary table
# =============================================================================

print("=== SUMMARY BY TREATMENT AND DAY ===")
print(trajectory_summary %>% arrange(Treatment, Day))
```



# Post treatment
```{r}
wide_post <- post_treatment_data %>%
  select(SampleID, clade_name, Relative_Abundance) %>%
  pivot_wider(names_from = clade_name, values_from = Relative_Abundance, values_fill = 0) %>%
  column_to_rownames("SampleID")

bray_post <- vegdist(wide_post, method = "bray")

metadata_post <- metadata %>%
  filter(SampleID %in% rownames(wide_post)) %>%
  mutate(Mouse = as.factor(Mouse)) %>%
  arrange(match(SampleID, rownames(wide_post)))

# Treatment effect - NO strata (between-mouse factor)
permanova_treatment_post <- adonis2(bray_post ~ Treatment, 
                                    data = metadata_post, 
                                    permutations = 999)

# Day effect - WITH strata (within-mouse factor)
permanova_day_post <- adonis2(bray_post ~ Day, 
                              data = metadata_post, 
                              strata = metadata_post$Mouse,
                              permutations = 999)

# Mouse effect
permanova_mouse_post <- adonis2(bray_post ~ Mouse,
                                data = metadata_post,
                                permutations = 999)

print("=== POST-TREATMENT PERMANOVA ===")
print("Treatment effect:")
print(permanova_treatment_post)
print("\nDay effect (blocking by Mouse):")
print(permanova_day_post)
print("\nMouse effect (individual variation):")
print(permanova_mouse_post)

# Create summary plot - FIXED: added $ before backticks
permanova_results_post <- data.frame(
  Factor = c("Treatment", "Day", "Mouse"),
  R2 = c(permanova_treatment_post$R2[1], 
         permanova_day_post$R2[1],
         permanova_mouse_post$R2[1]),
  P_value = c(permanova_treatment_post$`Pr(>F)`[1], 
              permanova_day_post$`Pr(>F)`[1],
              permanova_mouse_post$`Pr(>F)`[1])
)

p_permanova_post <- ggplot(permanova_results_post, aes(x = Factor, y = R2, fill = P_value < 0.05)) +
  geom_bar(stat = "identity", width = 0.5) +
  geom_text(aes(label = sprintf("R² = %.3f\np = %.3f", R2, P_value)), 
            vjust = -0.5, size = 4, fontface = "bold") +
  scale_fill_manual(values = c("TRUE" = "#EC6E1C", "FALSE" = "gray70"),
                    labels = c("TRUE" = "p < 0.05", "FALSE" = "p ≥ 0.05")) +
  labs(
    title = "PERMANOVA Results: Post-Treatment Microbiome",
    x = "",
    y = "R² (Variance Explained)",
    fill = "Significance"
  ) +
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.text.x = element_text(size = 14, face = "bold"),
    axis.title = element_text(size = 14, face = "bold"),
    legend.position = "bottom",
    legend.title = element_text(size = 12, face = "bold")
  ) +
  ylim(0, max(permanova_results_post$R2) * 1.25)

print(p_permanova_post)


ggsave("post_treatment_permanova.png", p_permanova_post,
       path = plots_path, width = 10, height = 7, dpi = 300)
```

```{r}
# Perform PCoA analysis
pcoa <- cmdscale(bray_curtis_matrix, eig = TRUE, k = 2)

# Extract coordinates
pcoa_coords <- as.data.frame(pcoa$points)
colnames(pcoa_coords) <- c("PC1", "PC2")

# Calculate variance explained (as percentage)
eigenvalues <- pcoa$eig
var_explained <- eigenvalues / sum(eigenvalues) * 100

# Add metadata
pcoa_coords$SampleID <- rownames(pcoa_coords)
pcoa_data <- pcoa_coords %>%
  left_join(metadata, by = "SampleID")


# Create the plot
p2 <- ggplot(pcoa_data, aes(x = PC1, y = PC2, color = Day, shape = Treatment)) +
  geom_point(size = 4, alpha = 0.7) +
  scale_shape_manual(values = c(16, 17, 18, 15)) +
  scale_color_viridis_d(option = "turbo") +
  labs(
    title = "PCoA of Genus-level Bacterial Communities",
    x = paste0("PC1 (", round(var_explained[1], 2), "%)"),
    y = paste0("PC2 (", round(var_explained[2], 2), "%)")
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.title = element_text(size = 12),
    legend.position = "right",
    panel.grid.major = element_line(color = "lightgray", linewidth = 0.3)
  )

print(p2)

# ggsave(
#   filename = "PCoA_Genera_Hauser.png",
#   plot = p2,
#   path = plots_path,
#   width = 10,
#   height = 6,
#   dpi = 300
# )
```





```{r}

###PCoA

# Filter out Day -5
genus_data_filtered <- genus_data %>%
  filter(Day != "0")

# Transform to wide format
wide_data_filtered <- genus_data_filtered %>%
  filter(clade_name != "") %>%
  select(SampleID, clade_name, Relative_Abundance) %>%
  pivot_wider(names_from = clade_name, values_from = Relative_Abundance, values_fill = 0) %>%
  column_to_rownames("SampleID")

# Calculate Bray-Curtis dissimilarity matrix
bray_curtis_matrix_filtered <- vegdist(wide_data_filtered, method = "bray")

# Match metadata
metadata_ordered_filtered <- metadata[match(rownames(wide_data_filtered), metadata$SampleID),]

# Run PERMANOVA tests
permanova_treatment_filtered <- adonis2(bray_curtis_matrix_filtered ~ Treatment, data = metadata_ordered_filtered, strata = metadata_ordered_filtered$Day, permutations = 999)
permanova_day_filtered <- adonis2(bray_curtis_matrix_filtered ~ Day, data = metadata_ordered_filtered, strata = metadata_ordered_filtered$Treatment, permutations = 999)

print("PERMANOVA results for Treatment (Day -5 removed):")
print(permanova_treatment_filtered)
print("PERMANOVA results for Day (Day -5 removed):")
print(permanova_day_filtered)

# PCoA plot
pcoa_filtered <- cmdscale(bray_curtis_matrix_filtered, eig = TRUE, k = 2)
pcoa_coords_filtered <- as.data.frame(pcoa_filtered$points)
colnames(pcoa_coords_filtered) <- c("PC1", "PC2")
eigenvalues_filtered <- pcoa_filtered$eig
var_explained_filtered <- eigenvalues_filtered / sum(eigenvalues_filtered) * 100

pcoa_coords_filtered$SampleID <- rownames(pcoa_coords_filtered)
pcoa_data_filtered <- pcoa_coords_filtered %>%
  left_join(metadata, by = "SampleID")

p_filtered <- ggplot(pcoa_data_filtered, aes(x = PC1, y = PC2, color = Day, shape = Treatment)) +
  geom_point(size = 4, alpha = 0.7) +
  scale_shape_manual(values = c(16, 17, 18, 15)) +
  scale_color_viridis_d(option = "turbo") +
  labs(
    title = "PCoA of Genus-level (Day 0 Removed)",
    x = paste0("PC1 (", round(var_explained_filtered[1], 2), "%)"),
    y = paste0("PC2 (", round(var_explained_filtered[2], 2), "%)")
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.title = element_text(size = 12),
    legend.position = "right",
    panel.grid.major = element_line(color = "lightgray", linewidth = 0.3)
  )

print(p_filtered)

# ggsave(
#   filename = "PCoA_Genera_Hauser_day0_removed.png",
#   plot = p_filtered,
#   path = plots_path,
#   width = 10,
#   height = 6,
#   dpi = 300
# )
```

#### Overall abundance patterns
```{r}

#### Overall abundance patterns
mean_abundance <- genus_data %>%
  group_by(clade_name) %>%
  summarize(mean_abundance = mean(Relative_Abundance)) %>%
  arrange(desc(mean_abundance)) %>%
  head(10)

top10_genera <- mean_abundance$clade_name[1:10]
top5_genera <- mean_abundance$clade_name[1:5]

# Remove if not using, or keep for later
# treatment_day_patterns <- genus_data %>%
#   filter(clade_name %in% top10_genera) %>%
#   group_by(Day, Treatment, clade_name) %>%
#   summarize(mean_abundance = mean(Relative_Abundance),
#             se = sd(Relative_Abundance)/sqrt(n())) %>%
#   ungroup()

p3 <- ggplot(mean_abundance,
             aes(x = reorder(clade_name, -mean_abundance),
                 y = mean_abundance * 100)) +
  geom_bar(stat = "identity", fill = "#2C5985", width = 0.7) +
  labs(
    title = "Top 10 Most Abundant Genera",
    x = "Genus",
    y = "Mean Relative Abundance (%)"
  ) +
  theme_classic(base_size = 14, base_family = "sans") +
  theme(
    plot.title = element_text(hjust = 0.5, size = 20, face = "bold", margin = margin(b = 15)),
    axis.title.x = element_text(size = 16, face = "bold", margin = margin(t = 10)),
    axis.title.y = element_text(size = 16, face = "bold", margin = margin(r = 10)),
    axis.text.x = element_text(size = 12, angle = 45, hjust = 1, vjust = 1, color = "black"),
    axis.text.y = element_text(size = 12, color = "black", face = "bold"),
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black", linewidth = 0.8),
    plot.margin = margin(10, 15, 10, 10)
  )

top3_genera <- mean_abundance %>%
  filter(clade_name != "Klebsiella") %>%
  head(3) %>%
  pull(clade_name)

# Plot 1: Top 3 genera - FIXED: factor(Day)
p4_top3 <- ggplot(genus_data %>% filter(clade_name %in% top3_genera), 
             aes(x = factor(Day), y = Relative_Abundance * 100, fill = Treatment)) +
  geom_boxplot() +
  facet_wrap(~clade_name) +
  scale_fill_brewer(palette = "Set2") +
  coord_cartesian(ylim = c(0, 100)) +
  labs(
    title = "Top 3 Most Abundant Genera by Day and Treatment",
    x = "Day",
    y = "Relative Abundance (%)"
  ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 14, face = "bold"),
    axis.text.y = element_text(size = 10, face = "bold"),
    plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
    axis.title.x = element_text(size = 18, face = "bold"),
    axis.title.y = element_text(size = 18, face = "bold"),
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 12, face = "bold"),
    legend.position = "right",
    legend.key.size = unit(1, 'cm'),
    axis.line.x = element_line(color = "#142D4A", linewidth = 0.8),
    axis.line.y = element_line(color = "#142D4A", linewidth = 0.8),
    strip.text = element_text(size = 12, face = "bold")
  )

# Plot 2: Klebsiella - FIXED: factor(Day)
p4_kleb <- ggplot(genus_data %>% filter(clade_name == "Klebsiella"), 
             aes(x = factor(Day), y = Relative_Abundance * 100, fill = Treatment)) +
  geom_boxplot() +
  scale_fill_brewer(palette = "Set2") +
  coord_cartesian(ylim = c(0, 30)) +
  labs(
    title = "Klebsiella Abundance by Day and Treatment",
    x = "Day",
    y = "Relative Abundance (%)"
  ) +
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 14, face = "bold"),
    axis.text.y = element_text(size = 10, face = "bold"),
    plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
    axis.title.x = element_text(size = 18, face = "bold"),
    axis.title.y = element_text(size = 18, face = "bold"),
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 12, face = "bold"),
    legend.position = "right",
    legend.key.size = unit(1, 'cm'),
    axis.line.x = element_line(color = "#142D4A", linewidth = 0.8),
    axis.line.y = element_line(color = "#142D4A", linewidth = 0.8)
  )

p3
p4_top3
p4_kleb

# ggsave("top_10_most_abundant_genera_hauser.png", p3,
#        path = plots_path, width = 10, height = 6, dpi = 300)

# ggsave("top3_genera_by_day_treatment.png", p4_top3,
#        path = plots_path, width = 18, height = 12, dpi = 300)

# ggsave("klebsiella_by_day_treatment.png", p4_kleb,
#        path = plots_path, width = 10, height = 8, dpi = 300)

```
```{r}
# Calculate mean abundance for each dataset
mean_abundance_all <- genus_data %>%
  group_by(clade_name) %>%
  summarize(mean_abundance = mean(Relative_Abundance)) %>%
  mutate(Dataset = "All Timepoints")

mean_abundance_baseline <- baseline_data %>%
  group_by(clade_name) %>%
  summarize(mean_abundance = mean(Relative_Abundance)) %>%
  mutate(Dataset = "Baseline (Day -5)")

mean_abundance_post <- post_treatment_data %>%
  group_by(clade_name) %>%
  summarize(mean_abundance = mean(Relative_Abundance)) %>%
  mutate(Dataset = "Post-Treatment")

# Get top 10 genera from ALL timepoints (for consistent ordering)
top10_all <- mean_abundance_all %>%
  arrange(desc(mean_abundance)) %>%
  head(10) %>%
  pull(clade_name)

# Combine and filter to top 10
combined_abundance <- bind_rows(
  mean_abundance_all,
  mean_abundance_baseline,
  mean_abundance_post
) %>%
  filter(clade_name %in% top10_all) %>%
  mutate(
    Dataset = factor(Dataset, levels = c("Baseline (Day -5)", "Post-Treatment", "All Timepoints")),
    clade_name = factor(clade_name, levels = top10_all)  # Order by overall abundance
  )

# Grouped bar plot
p_compare <- ggplot(combined_abundance,
                    aes(x = clade_name, y = mean_abundance * 100, fill = Dataset)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.7) +
  scale_fill_manual(values = c("Baseline (Day -5)" = "#2C5985", 
                               "Post-Treatment" = "#EC6E1C", 
                               "All Timepoints" = "#8C8C8C")) +
  labs(
    title = "Top 10 Most Abundant Genera: Baseline vs Post-Treatment",
    x = "Genus",
    y = "Mean Relative Abundance (%)",
    fill = ""
  ) +
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),
    axis.title.x = element_text(size = 16, face = "bold", margin = margin(t = 10)),
    axis.title.y = element_text(size = 16, face = "bold", margin = margin(r = 10)),
    axis.text.x = element_text(size = 12, angle = 45, hjust = 1, vjust = 1, face = "bold"),
    axis.text.y = element_text(size = 12, face = "bold"),
    legend.position = "bottom",
    legend.text = element_text(size = 12, face = "bold"),
    axis.line = element_line(color = "black", linewidth = 0.8)
  )

print(p_compare)

# ggsave("top10_genera_baseline_vs_posttreatment.png", p_compare,
#        path = plots_path, width = 14, height = 8, dpi = 300)
```

##### Core genera calculation
```{r}
##### Core genera calculation
# Calculate presence/absence for each genus per treatment
core_genera <- genus_data %>%
  group_by(Day, clade_name) %>%
  summarize(
    Prevalence = n_distinct(SampleID[Relative_Abundance > 0.005]) / n_distinct(SampleID) * 100,
    Mean_Abundance = mean(Relative_Abundance, na.rm = TRUE),
    SD_Abundance = sd(Relative_Abundance, na.rm = TRUE)
  ) %>%
  ungroup()

# Filter for core genera (present in >80% of samples)
core_genera_filtered <- core_genera %>%
  filter(Prevalence >= 70) %>%
  arrange(Day, desc(Mean_Abundance))

##### Core species calculation
core_species <- species_data %>%
  group_by(Day, clade_name) %>%
  summarize(
    Prevalence = n_distinct(SampleID[Relative_Abundance > 0.005]) / n_distinct(SampleID) * 100,
    Mean_Abundance = mean(Relative_Abundance, na.rm = TRUE),
    SD_Abundance = sd(Relative_Abundance, na.rm = TRUE)
  ) %>%
  ungroup()

# Filter for core species (present in >80% of samples)
core_species_filtered <- core_species %>%
  filter(Prevalence >= 70) %>%
  arrange(Day, desc(Mean_Abundance))

core_genera_list <- unique(core_genera_filtered$clade_name)
core_species_list <- unique(core_species_filtered$clade_name)

```
###Heatmap of prevalence

```{r}
custom_colors <- c("#26456E", "#1c54a8", "#FFE04F", "#ffbb78","#EC6E1C", "#9F3632")

# 2. Heatmap of prevalence
p_core_g <- ggplot(core_genera_filtered, 
             aes(x = reorder(clade_name, -Prevalence), 
                 y = Day, 
                 fill = Prevalence)) +
  geom_tile() +
  scale_fill_gradientn(colors = custom_colors) +
  coord_fixed() +
  labs(
    title = " >70% Prevelant Genera",
    x = "Genus",
    y = "Day",
    fill = "Prevalence (%)"
  ) + theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
  ) + theme(
    legend.position = "bottom",
    strip.text = element_text(size = 18, face = "bold", color = "black"),
    strip.background = element_rect(fill = "gray90", color = "gray20"),
    axis.text.x = element_text(size = 16,angle = 45, hjust = 1),
    axis.text.y = element_text(size = 16, face = "bold"),
    axis.title = element_text(size = 16, face = "bold"),
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5),
    legend.title = element_text(size = 20, face = "bold"),
    legend.text = element_text(size = 18)
  )


p_core_s <- ggplot(core_species_filtered, 
             aes(x = reorder(clade_name, -Prevalence), 
                 y = Day, 
                 fill = Prevalence)) +
  geom_tile() +
  scale_fill_gradientn(colors = custom_colors) +
  coord_fixed() +
  labs(
    title = " >70% Prevelant Spicies",
    x = "Species",
    y = "Day",
    fill = "Prevalence (%)"
  ) +
  theme(legend.position = "bottom") +   # put legend below plot
  guides(
    fill = guide_colourbar(
      title.position = "top",
      title.hjust    = 0.5,
      barwidth       = unit(8, "cm"),   # make the bar long
      barheight      = unit(0.5, "cm"), # and comfortably thick
      label.theme    = element_text(size = 12, face = "bold")
    )
  ) + theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
  ) + theme(
    legend.position = "bottom",
    strip.text = element_text(size = 18, face = "bold", color = "black"),
    strip.background = element_rect(fill = "gray90", color = "gray20"),
    axis.text.x = element_text(size = 16,angle = 45, hjust = 1),
    axis.text.y = element_text(size = 16, face = "bold"),
    axis.title = element_text(size = 16, face = "bold"),
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5),
    legend.title = element_text(size = 20, face = "bold"),
    legend.text = element_text(size = 18)
  )

print(p_core_g)
print(p_core_s)

# ggsave(
#   filename = "70 prevalent Genera by Day .png",
#   plot = p_core_g,
#   path = plots_path,
#   width = 18,
#   height = 12,
#   dpi = 300
# )
# 
# 
# ggsave(
#   filename = "70 prevalent Species by Day .png",
#   plot = p_core_s,
#   path = plots_path,
#   width = 18,
#   height = 12,
#   dpi = 300
# )

```

```{r}
top10_post_overall <- post_treatment_data %>%
  group_by(clade_name) %>%
  summarize(mean_abundance = mean(Relative_Abundance)) %>%
  arrange(desc(mean_abundance)) %>%
  head(10)

p_top10_post_overall <- ggplot(top10_post_overall,
             aes(x = reorder(clade_name, -mean_abundance),
                 y = mean_abundance * 100)) +
  geom_bar(stat = "identity", fill = "#4D7EAB", width = 0.7) +
  labs(
    title = "Top 10 Most Abundant Genera - Post-Treatment",
    subtitle = "Overall across all treatments and timepoints",
    x = "Genus",
    y = "Mean Relative Abundance (%)"
  ) +
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 10, face = "italic"),
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12)
  )

print(p_top10_post_overall)


# ============================================================================
# TOP 10 MOST ABUNDANT GENERA - BY TREATMENT GROUP
# ============================================================================

# For each day, find top 10 genera overall
top10_by_day <- post_treatment_data %>%
  group_by(Day, clade_name) %>%
  summarize(mean_abundance = mean(Relative_Abundance), .groups = "drop") %>%
  group_by(Day) %>%
  slice_max(order_by = mean_abundance, n = 10) %>%
  ungroup()

# Get the list of top 10 genera for each day
top_genera_per_day <- top10_by_day %>%
  select(Day, clade_name) %>%
  distinct()

# Now get treatment-specific values for those top 10 genera per day
top10_with_treatments <- post_treatment_data %>%
  inner_join(top_genera_per_day, by = c("Day", "clade_name")) %>%
  group_by(Day, Treatment, clade_name) %>%
  summarize(mean_abundance = mean(Relative_Abundance), .groups = "drop")

# Create plot with facets by Day
p_top10_by_day <- ggplot(top10_with_treatments,
             aes(x = reorder(clade_name, mean_abundance), 
                 y = mean_abundance * 100,
                 fill = Treatment)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.8) +
  scale_fill_brewer(palette = "Set1") +
  facet_wrap(~Day, scales = "free", ncol = 2, 
             labeller = labeller(Day = function(x) paste("Day", x))) +
  labs(
    title = "Top 10 Most Abundant Genera by Day",
    subtitle = "Comparing treatment groups for each day's top 10 genera",
    x = "Genus",
    y = "Mean Relative Abundance (%)",
    fill = "Treatment"
  ) +
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 12, face = "italic"),
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 11, face = "bold"),
    axis.text.y = element_text(size = 11, face = "bold"),
    axis.title = element_text(size = 14, face = "bold"),
    strip.text = element_text(size = 14, face = "bold"),
    strip.background = element_rect(fill = "gray90"),
    legend.position = "bottom",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 11)
  )

print(p_top10_by_day)

# ggsave("post_top10_by_day_with_treatments.png", p_top10_by_day, 
#        path = plots_path, width = 16, height = 14, dpi = 300)




# ============================================================================
#  INDIVIDUAL MOUSE TRAJECTORIES 
# ============================================================================
nature_colors <- c("CK" = "#3770AC", "CZ" = "#9E421E", "V" = "#8C8C8C", "ZK" = "#327341")

p_temporal_top4_nature <- ggplot(temporal_summary_top4,
             aes(x = Day, y = mean_abundance * 100,
                 color = Treatment, group = Treatment)) +
  geom_line(linewidth = 0.8, alpha = 0.9) +
  geom_point(size = 2.5, alpha = 0.9) +
  geom_errorbar(aes(ymin = (mean_abundance - sem_abundance) * 100,
                    ymax = (mean_abundance + sem_abundance) * 100),
                width = 0.6, linewidth = 0.6, alpha = 0.7) +
  facet_wrap(~clade_name, scales = "free_y", ncol = 2) +
  scale_color_manual(values = nature_colors) +
  scale_x_continuous(breaks = c(0, 3, 10, 14)) +
  labs(
    title = "Temporal dynamics of dominant genera",
    x = "Day",
    y = "Mean relative abundance (%)",
    color = "Treatment"
  ) +
  theme_bw(base_size = 10) +  
  theme(
    # Plot title
    plot.title = element_text(hjust = 0, size = 11, face = "bold",
                              margin = margin(b = 10)),
    # Axes
    axis.title = element_text(size = 10, face = "bold", color = "black"),
    axis.text = element_text(size = 9, color = "black"),
    axis.line = element_line(color = "black", linewidth = 0.5),
    axis.ticks = element_line(color = "black", linewidth = 0.5),
    # Facet strips
    strip.text = element_text(size = 10, face = "bold.italic", color = "black"),
    strip.background = element_blank(),
    # Legend
    legend.position = "bottom",
    legend.title = element_text(size = 9, face = "bold"),
    legend.text = element_text(size = 9),
    legend.key.size = unit(0.8, "lines"),
    legend.background = element_blank(),
    legend.box.background = element_blank(),
    # Grid and background
    panel.grid.major = element_line(color = "gray90", linewidth = 0.3),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(color = "black", linewidth = 0.5, fill = NA),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white", color = NA),
    # Spacing
    plot.margin = margin(10, 10, 10, 10)
  )

print(p_temporal_top4_nature)


ggsave("temporal_dynamics_nature_style.png", p_temporal_top4_nature,
       path = plots_path, width = 180, height = 150, units = "mm", 
       dpi = 600, device = "png", type = "cairo")




```

```{r}
# Filter for Day -5 baseline samples only
baseline_data <- genus_data %>%
  filter(Day == -5)

# Create wide matrix for heatmap (genera as rows, samples as columns)
baseline_wide <- baseline_data %>%
  select(SampleID, clade_name, Relative_Abundance) %>%
  mutate(Relative_Abundance = Relative_Abundance * 100) %>%
  pivot_wider(names_from = SampleID, values_from = Relative_Abundance, values_fill = 0) %>%
  column_to_rownames("clade_name")

# Remove genera with zero abundance across all samples
baseline_wide <- baseline_wide[rowSums(baseline_wide) > 0, ]

# Filter to genera with mean abundance > threshold
abundance_threshold <- 0.01
baseline_wide_filtered <- baseline_wide[rowMeans(baseline_wide) > abundance_threshold, ]

# Get sample metadata for annotation - ordered by Mouse
sample_annotation <- baseline_data %>%
  select(SampleID, Treatment, Mouse) %>%
  distinct() %>%
  arrange(Mouse, Treatment) %>%
  column_to_rownames("SampleID")

# Reorder columns of the matrix to match the annotation order
baseline_wide_filtered <- baseline_wide_filtered[, rownames(sample_annotation)]

# FIXED: Generate colors for actual Mouse names (CK-1, V-2, etc.)
unique_mice <- unique(sample_annotation$Mouse)
n_mice <- length(unique_mice)
mouse_palette <- colorRampPalette(c("#66C2A5", "#FC8D62", "#8DA0CB", "#E78AC3", 
                                     "#A6D854", "#FFD92F", "#E5C494", "#B3B3B3"))(n_mice)
names(mouse_palette) <- sort(unique_mice)

annotation_colors <- list(
  Treatment = c("CK" = "#3770AC", "CZ" = "#9E421E", "V" = "#8C8C8C", "ZK" = "#327341"),
  Mouse = mouse_palette
)

baseline_wide_log <- log10(baseline_wide_filtered + 0.01)

range(baseline_wide_log)

p_baseline_log_pct <- pheatmap(
  as.matrix(baseline_wide_log),
  scale = "none",
  clustering_distance_rows = "euclidean",
  clustering_method = "complete",
  cluster_cols = FALSE,
  annotation_col = sample_annotation,
  annotation_colors = annotation_colors,
  color = viridis(100),
  fontsize_row = 8,
  fontsize_col = 9,
  main = "Baseline (Day -5) Genus Relative Abundance - Log10(%) Ordered by Mouse",
  show_rownames = TRUE,
  show_colnames = TRUE,
  border_color = NA,
  angle_col = 45,
  gaps_col = cumsum(table(sample_annotation$Mouse)),
  legend_breaks = c(-2, -1, 0, 1, 1.73),
  legend_labels = c("0.01%", "0.1%", "1%", "10%", "~54%")
)

png(file.path(plots_path, "baseline_day-5_genus_heatmap_log10pct.png"), 
    width = 18, height = 14, units = "in", res = 300)
print(p_baseline_log_pct)
dev.off()

```
```{r}
## defining baseline for each mouse

## Second heatmap: Mean baseline per mouse

baseline_mouse <- genus_data %>%
  filter(Day == -5) %>%
  group_by(Mouse, clade_name) %>%
  summarize(
    Mean_Relative_Abundance = mean(Relative_Abundance, na.rm = TRUE),
    .groups = "drop"
  )

baseline_mouse_wide <- baseline_mouse %>%
  mutate(Mean_Relative_Abundance = Mean_Relative_Abundance * 100) %>%
  pivot_wider(names_from = Mouse, values_from = Mean_Relative_Abundance, values_fill = 0) %>%
  column_to_rownames("clade_name")

baseline_mouse_wide <- baseline_mouse_wide[rowSums(baseline_mouse_wide) > 0, ]

abundance_threshold <- 0.1
baseline_mouse_filtered <- baseline_mouse_wide[rowMeans(baseline_mouse_wide) > abundance_threshold, ]

baseline_mouse_log <- log10(baseline_mouse_filtered + 0.01)

range(baseline_mouse_log)
heatmap_colors <- colorRampPalette(c("#B57E76", "#44459C"))(100)

# FIXED: Create column annotation for treatment (extract from Mouse name)
mouse_treatment <- data.frame(
  Mouse = colnames(baseline_mouse_log)
) %>%
  mutate(Treatment = str_extract(Mouse, "^[A-Z]+")) %>%
  column_to_rownames("Mouse")

p_baseline_mouse <- pheatmap(
  as.matrix(baseline_mouse_log),
  scale = "none",
  clustering_distance_rows = "euclidean",
  clustering_distance_cols = "euclidean",
  clustering_method = "complete",
  cluster_cols = TRUE,
  annotation_col = mouse_treatment,  # ADDED: shows treatment per mouse
  annotation_colors = list(
    Treatment = c("CK" = "#3770AC", "CZ" = "#9E421E", "V" = "#8C8C8C", "ZK" = "#327341")
  ),
  color = heatmap_colors,
  fontsize_row = 8,
  fontsize_col = 12,
  main = "Baseline (Day -5) Mean Genus Abundance per Mouse - Log10(%)",
  show_rownames = TRUE,
  show_colnames = TRUE,
  border_color = NA,
  angle_col = 45,
  legend_breaks = c(-2, -1, 0, 1, 1.73),
  legend_labels = c("0.01%", "0.1%", "1%", "10%", "~54%")
)

png(file.path(plots_path, "mice_mean_baseline_heatmap.png"), 
    width = 18, height = 14, units = "in", res = 300)
print(p_baseline_mouse)
dev.off()

```
### heatmap for all Day, mean abundance

```{r}


# =============================================================================
# HEATMAP: All Days, Mean Abundance per Mouse per Day
# =============================================================================

# Calculate mean abundance per Mouse per Day per Genus
all_days_mouse <- genus_data %>%
  group_by(Mouse, Day, clade_name) %>%
  summarize(
    Mean_Relative_Abundance = mean(Relative_Abundance, na.rm = TRUE),
    .groups = "drop"
  )

# Create unique sample identifier (Mouse_Day)
all_days_mouse <- all_days_mouse %>%
  mutate(Mouse_Day = paste0(Mouse, "_D", Day))

# Convert to wide format (genera as rows, Mouse_Day as columns)
all_days_wide <- all_days_mouse %>%
  mutate(Mean_Relative_Abundance = Mean_Relative_Abundance * 100) %>%
  select(Mouse_Day, clade_name, Mean_Relative_Abundance) %>%
  pivot_wider(names_from = Mouse_Day, values_from = Mean_Relative_Abundance, values_fill = 0) %>%
  column_to_rownames("clade_name")

# Remove genera with zero abundance
all_days_wide <- all_days_wide[rowSums(all_days_wide) > 0, ]

# Filter by abundance threshold
abundance_threshold <- 0.1
all_days_filtered <- all_days_wide[rowMeans(all_days_wide) > abundance_threshold, ]

# Log10 transform
all_days_log <- log10(all_days_filtered + 0.01)

# Create annotation dataframe
col_annotation <- data.frame(
  Mouse_Day = colnames(all_days_log)
) %>%
  mutate(
    Mouse = str_extract(Mouse_Day, "^[A-Z]+-[0-9]+"),
    Treatment = str_extract(Mouse_Day, "^[A-Z]+"),
    Day = as.numeric(str_extract(Mouse_Day, "-?[0-9]+$"))
  ) %>%
  mutate(Day = factor(Day, levels = c(-5, 0, 3, 10, 14))) %>%
  column_to_rownames("Mouse_Day")

# Order columns by Day then Treatment then Mouse
col_order <- rownames(col_annotation)[order(col_annotation$Day, 
                                             col_annotation$Treatment, 
                                             col_annotation$Mouse)]
all_days_log <- all_days_log[, col_order]
col_annotation <- col_annotation[col_order, ]

# Define annotation colors - UPDATED with your palette
day_colors <- c("-5" = "#F4D166", 
                "0" = "#C1E9B3", 
                "3" = "#B254A5", 
                "10" = "#626496", 
                "14" = "#B71D3E")

annotation_colors <- list(
  Treatment = c("CK" = "#3770AC", "CZ" = "#9E421E", "V" = "#8C8C8C", "ZK" = "#327341"),
  Day = day_colors
)

# Calculate gaps between days
day_counts <- table(col_annotation$Day)
gaps_positions <- cumsum(day_counts)

# Custom heatmap color scale - UPDATED
heatmap_colors <- colorRampPalette(c("#B57E76", "#44459C"))(100)

p_all_days <- pheatmap(
  as.matrix(all_days_log),
  scale = "none",
  clustering_distance_rows = "euclidean",
  clustering_method = "complete",
  cluster_cols = FALSE,
  annotation_col = col_annotation %>% select(Treatment, Day),
  annotation_colors = annotation_colors,
  color = heatmap_colors,
  
  # Bigger fonts
  fontsize = 18,         # global base
  fontsize_row = 14,
  fontsize_col = 14,
  
  # Bold title
  main = expression(bold("Genus Relative Abundance Across All Days - Log10(%)")),
  
  show_rownames = TRUE,
  show_colnames = TRUE,
  border_color = NA,
  angle_col = 90,
  gaps_col = gaps_positions[-length(gaps_positions)],
  legend_breaks = c(-2, -1, 0, 1, 1.73),
  legend_labels = c("0.01%", "0.1%", "1%", "10%", "~54%")
)


png(file.path(plots_path, "all_days_genus_heatmap_log10pct.png"),
    width = 26, height = 18, units = "in", res = 300)
print(p_all_days)
dev.off()
```
```{r}
# =============================================================================
# KLEBSIELLA COLONIZATION SUCCESS BY STRAIN COMBINATION
# =============================================================================

# Extract Klebsiella data only
klebsiella_data <- genus_data %>%
  filter(clade_name == "Klebsiella") %>%
  mutate(
    Treatment = factor(Treatment, levels = c("V", "CK", "CZ", "ZK")),
    Day = as.numeric(Day),
    Abundance_Pct = Relative_Abundance * 100
  )

# Check we have data
print(paste("Klebsiella observations:", nrow(klebsiella_data)))
print(table(klebsiella_data$Treatment, klebsiella_data$Day))

# =============================================================================
# 1. KLEBSIELLA TRAJECTORY BY TREATMENT (Mean ± SE)
# =============================================================================

kleb_summary <- klebsiella_data %>%
  group_by(Treatment, Day) %>%
  summarize(
    mean_abundance = mean(Abundance_Pct, na.rm = TRUE),
    sd_abundance = sd(Abundance_Pct, na.rm = TRUE),
    n = n(),
    se_abundance = sd_abundance / sqrt(n),
    .groups = "drop"
  )

treatment_colors <- c("V" = "#8C8C8C", "CK" = "#3770AC", "CZ" = "#9E421E", "ZK" = "#327341")

p_kleb_trajectory <- ggplot(kleb_summary, 
                            aes(x = Day, y = mean_abundance, color = Treatment, group = Treatment)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50", linewidth = 0.8) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 3.5) +
  geom_errorbar(aes(ymin = mean_abundance - se_abundance,
                    ymax = mean_abundance + se_abundance),
                width = 0.5, linewidth = 0.8) +
  scale_color_manual(values = treatment_colors) +
  scale_x_continuous(breaks = c(-5, 0, 3, 10, 14)) +
  annotate("text", x = 0.5, y = max(kleb_summary$mean_abundance) * 0.95,
           label = "Antibiotics +\nInoculation", size = 3, hjust = 0, fontface = "italic") +
  labs(
    title = "Klebsiella Colonization Dynamics by Treatment",
    subtitle = "Mean ± SE across mice",
    x = "Day",
    y = "Relative Abundance (%)",
    color = "Treatment"
  ) +
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 12, face = "italic"),
    axis.title = element_text(size = 14, face = "bold"),
    axis.text = element_text(size = 12, face = "bold"),
    legend.position = "right",
    legend.title = element_text(size = 12, face = "bold")
  )

print(p_kleb_trajectory)

# =============================================================================
# 2. INDIVIDUAL MOUSE TRAJECTORIES
# =============================================================================

p_kleb_individual <- ggplot(klebsiella_data,
                            aes(x = Day, y = Abundance_Pct, color = Treatment, group = Mouse)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50", linewidth = 0.6) +
  geom_line(linewidth = 0.8, alpha = 0.7) +
  geom_point(size = 2, alpha = 0.8) +
  facet_wrap(~Treatment, nrow = 1) +
  scale_color_manual(values = treatment_colors) +
  scale_x_continuous(breaks = c(-5, 0, 3, 10, 14)) +
  labs(
    title = "Individual Mouse Klebsiella Colonization",
    subtitle = "Each line = one mouse",
    x = "Day",
    y = "Relative Abundance (%)"
  ) +
  theme_classic(base_size = 12) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, size = 10, face = "italic"),
    axis.title = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(size = 10, face = "bold", angle = 45, hjust = 1),
    axis.text.y = element_text(size = 10, face = "bold"),
    strip.text = element_text(size = 14, face = "bold"),
    strip.background = element_rect(fill = "gray95"),
    legend.position = "none"
  )

print(p_kleb_individual)

# =============================================================================
# 3. COLONIZATION SUCCESS METRICS
# =============================================================================

# Calculate per-mouse colonization metrics (post-treatment only: Days 0, 3, 10, 14)
colonization_metrics <- klebsiella_data %>%
  filter(Day >= 0) %>%
  group_by(Mouse, Treatment) %>%
  summarize(
    # Peak abundance
    Peak_Abundance = max(Abundance_Pct, na.rm = TRUE),
    Day_of_Peak = Day[which.max(Abundance_Pct)],
    
    # Final abundance (Day 14 persistence)
    Final_Abundance = Abundance_Pct[Day == 14],
    
    # Area under curve (total colonization burden) - simple trapezoidal
    AUC = sum(diff(sort(unique(Day))) * 
              (head(Abundance_Pct[order(Day)], -1) + tail(Abundance_Pct[order(Day)], -1)) / 2),
    
    # Early colonization (Day 3)
    Day3_Abundance = Abundance_Pct[Day == 3],
    
    .groups = "drop"
  )

print("=== COLONIZATION METRICS BY MOUSE ===")
print(colonization_metrics %>% arrange(Treatment, Mouse))

# Summary by treatment
colonization_summary <- colonization_metrics %>%
  group_by(Treatment) %>%
  summarize(
    n_mice = n(),
    Peak_mean = mean(Peak_Abundance, na.rm = TRUE),
    Peak_se = sd(Peak_Abundance, na.rm = TRUE) / sqrt(n()),
    Final_mean = mean(Final_Abundance, na.rm = TRUE),
    Final_se = sd(Final_Abundance, na.rm = TRUE) / sqrt(n()),
    AUC_mean = mean(AUC, na.rm = TRUE),
    AUC_se = sd(AUC, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

print("=== COLONIZATION SUMMARY BY TREATMENT ===")
print(colonization_summary)

# =============================================================================
# 4. STATISTICAL TESTS - Kruskal-Wallis (non-parametric)
# =============================================================================

print("=== STATISTICAL TESTS ===")

# Peak abundance
kw_peak <- kruskal.test(Peak_Abundance ~ Treatment, data = colonization_metrics)
print("Peak Abundance - Kruskal-Wallis:")
print(kw_peak)

# Final abundance (Day 14)
kw_final <- kruskal.test(Final_Abundance ~ Treatment, data = colonization_metrics)
print("Final Abundance (Day 14) - Kruskal-Wallis:")
print(kw_final)

# AUC
kw_auc <- kruskal.test(AUC ~ Treatment, data = colonization_metrics)
print("AUC (Total Burden) - Kruskal-Wallis:")
print(kw_auc)

# Pairwise comparisons if significant
if (kw_peak$p.value < 0.05) {
  print("Peak Abundance - Pairwise Wilcoxon:")
  print(pairwise.wilcox.test(colonization_metrics$Peak_Abundance, 
                              colonization_metrics$Treatment, 
                              p.adjust.method = "BH"))
}

if (kw_auc$p.value < 0.05) {
  print("AUC - Pairwise Wilcoxon:")
  print(pairwise.wilcox.test(colonization_metrics$AUC, 
                              colonization_metrics$Treatment, 
                              p.adjust.method = "BH"))
}

# =============================================================================
# 5. BOXPLOTS OF COLONIZATION METRICS
# =============================================================================

# Reshape for faceted boxplot
metrics_long <- colonization_metrics %>%
  pivot_longer(
    cols = c(Peak_Abundance, Final_Abundance, AUC),
    names_to = "Metric",
    values_to = "Value"
  ) %>%
  mutate(Metric = factor(Metric, 
                         levels = c("Peak_Abundance", "Final_Abundance", "AUC"),
                         labels = c("Peak Abundance (%)", "Day 14 Abundance (%)", "AUC (Total Burden)")))

p_metrics_boxplot <- ggplot(metrics_long, 
                            aes(x = Treatment, y = Value, fill = Treatment)) +
  geom_boxplot(alpha = 0.8, outlier.shape = NA) +
  geom_jitter(width = 0.15, size = 2, alpha = 0.7) +
  facet_wrap(~Metric, scales = "free_y", nrow = 1) +
  scale_fill_manual(values = treatment_colors) +
  labs(
    title = "Klebsiella Colonization Success Metrics by Treatment",
    x = "",
    y = ""
  ) +
  theme_classic(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.text.x = element_text(size = 12, face = "bold"),
    axis.text.y = element_text(size = 11, face = "bold"),
    strip.text = element_text(size = 12, face = "bold"),
    strip.background = element_rect(fill = "gray95"),
    legend.position = "none"
  )

print(p_metrics_boxplot)

# =============================================================================
# 6. HEATMAP: Klebsiella abundance per Mouse per Day
# =============================================================================

kleb_heatmap_data <- klebsiella_data %>%
  select(Mouse, Day, Abundance_Pct) %>%
  mutate(Day = factor(Day, levels = c(-5, 0, 3, 10, 14))) %>%
  pivot_wider(names_from = Day, values_from = Abundance_Pct, values_fill = 0) %>%
  column_to_rownames("Mouse")

# Row annotation (Treatment)
row_annotation <- data.frame(
  Mouse = rownames(kleb_heatmap_data)
) %>%
  mutate(Treatment = str_extract(Mouse, "^[A-Z]+")) %>%
  column_to_rownames("Mouse")

# Order by treatment
row_order <- rownames(row_annotation)[order(row_annotation$Treatment)]
kleb_heatmap_data <- kleb_heatmap_data[row_order, ]
row_annotation <- row_annotation[row_order, , drop = FALSE]

# Heatmap colors
heatmap_colors <- colorRampPalette(c("#FFFFFF", "#FEE5D9", "#FCAE91", 
                                      "#FB6A4A", "#CB181D", "#67000D"))(100)

p_kleb_heatmap <- pheatmap(
  as.matrix(kleb_heatmap_data),
  scale = "none",
  cluster_rows = FALSE,
  cluster_cols = FALSE,
  annotation_row = row_annotation,
  annotation_colors = list(
    Treatment = c("CK" = "#3770AC", "CZ" = "#9E421E", "V" = "#8C8C8C", "ZK" = "#327341")
  ),
  color = heatmap_colors,
  fontsize_row = 10,
  fontsize_col = 12,
  main = "Klebsiella Colonization: Individual Mouse Trajectories",
  show_rownames = TRUE,
  show_colnames = TRUE,
  border_color = "white",
  cellwidth = 40,
  cellheight = 15,
  gaps_row = cumsum(table(row_annotation$Treatment))[-length(table(row_annotation$Treatment))],
  display_numbers = TRUE,
  number_format = "%.1f",
  fontsize_number = 8
)

# =============================================================================
# SAVE PLOTS
# =============================================================================

# ggsave("klebsiella_trajectory_mean.png", p_kleb_trajectory,
#        path = plots_path, width = 10, height = 7, dpi = 300)

# ggsave("klebsiella_trajectory_individual.png", p_kleb_individual,
#        path = plots_path, width = 14, height = 5, dpi = 300)

# ggsave("klebsiella_colonization_metrics.png", p_metrics_boxplot,
#        path = plots_path, width = 14, height = 6, dpi = 300)

# png(file.path(plots_path, "klebsiella_heatmap_by_mouse.png"),
#     width = 10, height = 12, units = "in", res = 300)
# print(p_kleb_heatmap)
# dev.off()
```

